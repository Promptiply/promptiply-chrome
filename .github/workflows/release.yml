name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type (patch, minor, major)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tag comparison

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Determine version
        id: version
        run: |
          # Get all tags
          git fetch --tags
          
          # Get the latest version tag (format: vX.Y.Z or X.Y.Z)
          LATEST_TAG=$(git tag -l --sort=-version:refname | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)
          
          if [ -z "$LATEST_TAG" ]; then
            # No tags exist, start with 0.1.0
            NEW_VERSION="0.1.0"
            echo "No existing tags found. Starting with version 0.1.0"
          else
            # Extract version number (remove 'v' prefix if present)
            VERSION_NUM=$(echo "$LATEST_TAG" | sed 's/^v//')
            
            # Split version into parts
            IFS='.' read -ra VERSION_PARTS <<< "$VERSION_NUM"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}
            
            # Increment based on input
            VERSION_TYPE="${{ github.event.inputs.version_type }}"
            
            if [ "$VERSION_TYPE" == "major" ]; then
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
            elif [ "$VERSION_TYPE" == "minor" ]; then
              MINOR=$((MINOR + 1))
              PATCH=0
            else  # patch
              PATCH=$((PATCH + 1))
            fi
            
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            echo "Latest tag: $LATEST_TAG"
            echo "Bumping $VERSION_TYPE version to: $NEW_VERSION"
          fi
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update manifest version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          jq --arg version "$VERSION" '.version = $version' manifest.json > manifest.json.tmp
          mv manifest.json.tmp manifest.json
          echo "Updated manifest.json version to $VERSION"

      - name: Package extension
        run: |
          zip -r promptiply-v${{ steps.version.outputs.version }}.zip . -x "*.git*" -x "*.DS_Store" -x "*README.md" -x ".github/*"

      - name: Create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json
          git commit -m "Bump version to ${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"
          git push origin HEAD || echo "No changes to push"

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## Release v${{ steps.version.outputs.version }}
            
            ### Installation
            1. Download the extension zip file below
            2. Open Chrome and navigate to `chrome://extensions/`
            3. Enable "Developer mode" (top right)
            4. Click "Load unpacked" and select the extracted folder
            5. Or use a tool like [CRX Extractor](https://robwu.nl/crxviewer/) to install the zip directly
            
            ### Changes
            See commit history for details.
          files: |
            promptiply-v${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: false

